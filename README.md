<img src="https://gust-production.s3.amazonaws.com/uploads/startup/logo_image/684061/logo_20carrinho_20e_20estrada.png" align="left" width="192px" height="192px"/>
<img align="left" width="0" height="192px" hspace="10"/>


# Menu Sun API

Este repositorio é um monolito de uma camada de integração entre a plataforma Menu Marketplace e a AmBev (Promax).
Ele está deployado usando AWS Lambda, RDS Aurora MYSQL e utilizando um endpoint feito em GraphQL.
Esse endpoint GraphQL expõe um conjunto de mutações e queries que podem ser utilizados para informar cliente, preço, estoque, produto, fechamento de pedido.

</br>

[Como iniciar](#como-iniciar) • [Contribuindo](#contribuindo) • [GraphiQl local](#iniciando-graphiql-localmente) • [Uso & Documentação da API](#usage--api-docs)

## Como Iniciar
To start contribute effectively, please follow our [contributing guidelines](#contributing) below.
Sending changes to the master branch require a reviewed pull request (by members of our team and some automated services) and are integrated by [Travis CI][12].

### Ambiente de Desenvolvimento


Primeiramente você deve clonar esse repositório para a sua máquina local:
```bash
$ git clone git@github.com:ztech-company/menu-sun-api.git
```

Recomendamos utilizar o o virtual environment ![Python Virtual Environments: A Primer][25] para instalar as dependências e rodar esse projeto.
Essa é maneira que você garantirá isolamento dps ambiente do projeto.
Parar criar um virtual environment você precisa ter instalado o ![virtualenv][20]:
```bash
$ [sudo] pip install virtualenv
```

Depois do virtualenv instalado, vá na pasta do projeto e crie o virtual environment com o comando:
```bash
$ virtualenv venv
```

Agora você precisa ativar o seu virtual environment como o seguinte comando:
```bash
$ source venv/bin/activate
```

Agora só é necessário a instalação das dependências do projeto. Essas dependência estão listadas no arquivo **requirements.txt**. Você pode instala-las rodando:
```bash
$ pip install -r requirements.txt
```

Para rodar o conjunto de testes unitários localmente, você precisará da instância do MySQL rodando. Para isso você pode utilizar o **makefile** que se encontra na raiz do projeto.
Ele subirá toda infrastutura necessária para rodar os testes. 
```bash
$ source venv/bin/activate
```

### Banco de Dados Local
### Configure the AWS profile locally
> Pergunte para o seu gerente sobre  `aws_access_key_id` e `aws_secret_access_key`.

## Contribuindo
### Code Style
Ainda não temos um estilo de código implementado. A ideia é utilizar o PEP8. Se este não for seguido, o commit será rejeitado

### Workflow
Nos estamos utilizando o *github flow* workflow para desenvolver novas features.
Isso significa que você deveria criar feature branches e integra-las usado pull requests.

![GitHub flow](https://cdn-images-1.medium.com/max/1600/1*iHPPa72N11sBI_JSDEGxEA.png "GitHub Flow")


> Leia [esse pequeno artigo][24] de Bailey Charlton para mais informações sobre o GitHub Flow .

Create a branch for every feature you are working on.
Your feature branch must be named **by the Jira ticket numbers related to the feature you are implementing**
(e.g. If the ticket is named "GC-384", the branch that will implement this feature also must be nammed `GC-384`).

Since we will deploy the whole infrastructure for every feature branch pushed to GitHub it is important to delete your feature branch just after merging the pull request so we can decommission the feature infrastructure.

### Database migrations
We a are using [Alembic][8] to manage the database migrations of our project.

To update the database to the current version of the model, run the command:
```sh
$ python scripts/alembic_generate.py upgrade CONN_STRING
```
> CONN_STRING stands for the SQLalchemy connection string pointing to the local development database

This command will apply to the local database all the migrations that haven't been applied yet.

Whenever a change to the database model is needed, a migration must to be created. To do it, run the command:
```sh
$ python scripts/alembic_generate.py revision CONN_STRING MESSAGE
```
It will generate an autogenerated python file in the `alembic/versions` folder with the differences from the actual database and the SQLAlchemy model code.
Again, since this file is autogenerated **the developer must check the file before commiting the changes**.
The Travis CI will apply the changes to the respective database when code is pushed.

### Writing Unit Tests
We are testing locally mostly by writing unit tests. Unit tests are located in the
`/tests` folder. Take a look at a few of them to see how we are currently making them.

You can run `pytest tests/` on the project root folder, after starting the **virtualenv** and installed the project dependencies and started the local database, to run the test suit.
This is also the folder that [Travis][12] will use to execute tests and evaluate code coverage.

## Starting GraphiQl Locally
This command will enable you to run Graphiql on your local environment by running flask server.

```sh
$ python app.py
```

For both admin_api and public_api to work you need to setup the following environment variables. We recomend to create a .env file in project root with contents:

```
STAGE=dev
DB_CONN_STRING="postgresql://courier:courier@localhost:5432/courier"
CONN_STRING_ZE="postgresql://courier:courier@localhost:5432/courier"
CONN_STRING_CH="postgresql://courier:courier@localhost:5432/courier"
```

## Logs Monitoring and Troubleshooting
Logs (for both develop and production and feature branches) of this project can be found on AWS CloudWatch.

## Bugs/Problems reporting
For reporting unexpected behaviour in courier services, refer to your local Product Owner. 

## Usage & API docs

Our front end is currently split into 4 repositories. Customer web, customer mobile, admin and delivery man clients

If you want to explore the API documentation you can do so by pointing a [Graphql Playground][28] to our production endpoint `https://api.zx-courier.com/public-api` and exploring from there.

## Owners

This project is maintained by ZX Global - Brazil.

You can find us in [Slack][4]. Please, don't hesitate to reach us if you have any questions.

[4]: https://zx-ventures.slack.com/messages/C9HJJ8YLC
[5]: https://github.com/ZXVentures/courier-front-master
[8]: http://alembic.zzzcomputing.com/en/latest/
[10]: http://courier-dev-graphiql.s3-website-us-west-2.amazonaws.com/
[12]: https://travis-ci.com/ZXVentures/courier-api
[13]: https://www.jetbrains.com/pycharm/
[14]: https://code.visualstudio.com/
[15]: https://serverless.com/
[18]: https://pip.pypa.io/en/stable/
[19]: https://nodejs.org/en/download/current/
[20]: https://virtualenv.pypa.io/en/stable/
[21]: https://docs.docker.com/install/
[27]: https://www.python.org/dev/peps/pep-0008/
[28]: https://github.com/prisma/graphql-playground
[22]: https://github.com/ZXVentures/courier-front-user
[24]: https://medium.com/@Web_Bailey/github-feature-branch-workflow-db3b24535d53
[25]: https://realpython.com/python-virtual-environments-a-primer/




### Como contribuir?
Para esse repositório utilizamos o conceito de trunk-based development. 
A cada push no repositorio central, um novo banco de dados será criado e um novo end-point apartado será criado.
Isso garante um ambiente totalmente apartado e independente de qualquer outro engenheiro.
Assim que terminar sua alterações, você deverá abrir um PR para a a branch master.
Após aprovada, suas alteracões são dispobilizadas diretamente em produção.

### Como configurar seu ambiente localmente?
1. Faça um clone do repositorio
3. Crie um arquivo .env na raiz do seu projeto. Nesse arquivo terão variáveis de ambiente do seu ambiente de desenvolvimento.
Na raiz do projeto, existe um arquivo env.sample. Recomendamos seguir renomeando-o para .env e utilizando ele no seu ambiente local.
2. execute make local/setup. Esse comando iniciará um docker mysql e aplicará as migrações necessárias
.

### Como realizar uma alteração no schema de dados?
1. Primeiro siga o passo-a-passo da seção "Configurando seu ambiente localmente"
2. Faça as alterações no modelo de dados, utilizamos as classes do ORM.
Essas classes estão sempre na pasta domain/model/{nome_do_dominio}.
2. Execute o make local/migration name={name}. Em name você informrá o nome da sua migração.
3. Será gerado automaticamente um sequência de migrações que serão armazenadas em alembic/scripts.
4. Valide se as migrações foram executadas corretamente.
5. Caso sim, execute make db/migrate. As migrações serão aplicadas localmente.

